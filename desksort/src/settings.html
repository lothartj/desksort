<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeskSort Settings</title>
    <style>
        :root {
            --primary: #007AFF;
            --bg: #F2F2F7;
            --card: #FFFFFF;
            --text: #1C1C1E;
            --border: #E5E5EA;
            --radius: 12px;
            --success: #34C759;
            --error: #FF3B30;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, system-ui, sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 24px;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .back-btn:hover {
            text-decoration: underline;
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 16px;
        }

        .extension-group {
            border-bottom: 1px solid var(--border);
            padding: 16px 0;
        }

        .extension-group:last-child {
            border: none;
        }

        .extension-header {
            font-weight: 600;
            margin-bottom: 12px;
        }

        .extension-item {
            display: grid;
            grid-template-columns: 120px 1fr auto;
            gap: 12px;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .extension-item:last-child {
            border: none;
        }

        .extension-name {
            font-weight: 500;
            color: var(--primary);
        }

        input[type="text"] {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            width: 100%;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
        }

        button.browse {
            background: var(--bg);
            color: var(--primary);
        }

        button:hover {
            opacity: 0.9;
        }

        .status {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
            z-index: 100;
        }

        .status.success {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success);
        }

        .status.error {
            background: rgba(255, 59, 48, 0.1);
            color: var(--error);
        }

        @media (max-width: 600px) {
            .extension-item {
                grid-template-columns: 1fr;
                gap: 8px;
                padding: 12px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <button class="back-btn" onclick="window.location.href='index.html'">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M19 12H5M12 19l-7-7 7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Back
                </button>
                <h1>Settings</h1>
            </div>
            <button id="saveBtn">Save All</button>
        </header>

        <div class="card">
            <div id="extensionGroups"></div>
        </div>
    </div>

    <div id="status" class="status"></div>

    <script>
        let invoke;
        let open;
        let status;
        let extensionGroups;
        let saveBtn;

        const EXTENSIONS = {
            Documents: ['.pdf', '.docx', '.doc', '.txt', '.odt', '.rtf'],
            Spreadsheets: ['.xls', '.xlsx', '.csv', '.ods'],
            Presentations: ['.pptx', '.odp', '.key'],
            Images: ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.tiff'],
            Videos: ['.mp4', '.mkv', '.avi', '.mov', '.webm', '.flv', '.wmv'],
            Audio: ['.mp3', '.wav', '.aac', '.ogg', '.flac'],
            Archives: ['.zip', '.rar', '.7z', '.tar', '.gz', '.tar.gz'],
            Executables: ['.exe', '.msi', '.sh', '.bat', '.AppImage'],
            Code: ['.js', '.py', '.rs', '.cpp', '.java', '.html', '.css', '.json', '.ts'],
            Folders: ['folder']
        };

        async function initTauri() {
            if (window.__TAURI__) {
                invoke = window.__TAURI__.invoke;
                open = window.__TAURI__.dialog.open;
                return true;
            }
            return false;
        }

        async function init() {
            try {
                console.log('Page loaded, initializing...');
                
                status = document.getElementById('status');
                extensionGroups = document.getElementById('extensionGroups');
                saveBtn = document.getElementById('saveBtn');

                let retries = 0;
                while (retries < 10) {
                    if (await initTauri()) {
                        break;
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retries++;
                }

                if (!invoke) {
                    throw new Error('Failed to initialize Tauri API');
                }

                console.log('Fetching saved mappings...');
                const mappings = await invoke('get_all_mappings');
                console.log('Got mappings:', mappings);
                renderUI(mappings);

                saveBtn.onclick = handleSave;
            } catch (e) {
                console.error('Failed to initialize:', e);
                showStatus('Failed to initialize app', true);
            }
        }

        function renderUI(mappings = []) {
            console.log('Rendering UI with mappings:', mappings);
            const mappingMap = new Map(mappings.map(m => [m.extension, m.target_path]));
            
            extensionGroups.innerHTML = Object.entries(EXTENSIONS).map(([group, exts]) => {
                return `
                    <div class="extension-group">
                        <div class="extension-header">${group}</div>
                        ${exts.map(ext => {
                            const path = mappingMap.get(ext) || '';
                            const inputId = ext.replace(/[.]/g, '_');
                            return `
                                <div class="extension-item">
                                    <div class="extension-name">${ext}</div>
                                    <input type="text" 
                                        id="${inputId}" 
                                        value="${path}" 
                                        placeholder="Select destination folder">
                                    <button class="browse" onclick="browsePath('${inputId}')">
                                        Browse
                                    </button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }).join('');
        }

        async function browsePath(inputId) {
            try {
                console.log('Opening folder dialog for:', inputId);
                const selected = await open({
                    directory: true,
                    multiple: false
                });
                console.log('Selected path:', selected);
                if (selected) {
                    document.getElementById(inputId).value = selected;
                }
            } catch (e) {
                console.error('Failed to select folder:', e);
                showStatus('Failed to select folder', true);
            }
        }
        window.browsePath = browsePath;

        function showStatus(msg, isError = false) {
            console.log(`Status: ${msg} (${isError ? 'error' : 'success'})`);
            status.textContent = msg;
            status.className = `status ${isError ? 'error' : 'success'}`;
            status.style.display = 'block';
            setTimeout(() => status.style.display = 'none', 3000);
        }

        async function handleSave() {
            try {
                console.log('Saving settings...');
                let saved = 0;
                for (const [_, exts] of Object.entries(EXTENSIONS)) {
                    for (const ext of exts) {
                        const inputId = ext.replace(/[.]/g, '_');
                        const path = document.getElementById(inputId).value.trim();
                        if (path) {
                            console.log(`Saving mapping: ${ext} -> ${path}`);
                            await invoke('set_path_mapping', { 
                                extension: ext, 
                                target_path: path 
                            });
                            saved++;
                        }
                    }
                }
                console.log(`Saved ${saved} mappings`);
                showStatus(`Saved ${saved} path mappings`);
            } catch (e) {
                console.error('Failed to save settings:', e);
                showStatus('Failed to save settings', true);
            }
        }

        init();
    </script>
</body>
</html> 